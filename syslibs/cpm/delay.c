//
//  '########'########::'######:::'##::: ##'########'########:'#######:::'#####:::
//  ..... ##: ##.... ##'##... ##:: ###:: ## ##.....:..... ##:'##.... ##:'##.. ##::
//  :::: ##:: ##:::: ## ##:::..::: ####: ## ##:::::::::: ##:: ##:::: ##'##:::: ##:
//  ::: ##::: ##:::: ##. ######::: ## ## ## ######::::: ##:::: #######: ##:::: ##:
//  :: ##:::: ##:::: ##:..... ##:: ##. #### ##...::::: ##::::'##.... ## ##:::: ##:
//  : ##::::: ##:::: ##'##::: ##:: ##:. ### ##::::::: ##::::: ##:::: ##. ##:: ##::
//   ######## ########:. ######::: ##::. ## ######## ########. #######::. #####:::
//  ........:........:::......::::..::::..:........:........::.......::::.....::::
//
//  Sysbios C interface library
//  P.Betti  <pbetti@lpconsul.eu>
//
//  Module: c_bios
//
//  HISTORY:
//  -[Date]- -[Who]------------- -[What]---------------------------------------
//  27.09.18 Piergiorgio Betti   Creation date
//

#include <cpm.h>



void delay(uint16_t msec) __naked
{
	msec;

	__asm


	push	iy
	ld	iy,#4
	add	iy,sp

	ld	e, 0 (iy)			;
	ld	d, 1 (iy)			; DE = msec #

	;;
	;; DELAY
	;;
	;; This routine generate a delay from 1 to 65535 milliseconds.
	;;

	mscnt	.equ	246

	push	bc		; 11 c.
	push	af		; 11 c.

	00001$:
	ld	c, #mscnt	; 7 c.	(assume de = 1 = 1msec.)
	00002$:

	dec	c		; 4 c. * MSCNT
	jr	nz, 00002$	; 7/12 c. * MSCNT
	dec	de		; 6 c.
	ld	a, d		; 4 c.
	or	e		; 4 c.
	jr	nz, 00001$	; 7/12 c.

	pop	af		; 10 c.
	pop	bc		; 10 c.

	pop	iy

	ret

	__endasm;
}
